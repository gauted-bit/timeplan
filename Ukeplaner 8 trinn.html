<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ukeplan ‚Äì Lunner ungdomsskole</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4f1ec;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #7a7168;
  --border: #e2ddd5;
  --border-lt: #eeebe5;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --green: #059669;
  --green-light: #d1fae5;
  --orange: #ea580c;
  --orange-light: #ffedd5;
  --purple: #7c3aed;
  --purple-light: #ede9fe;
  --rose: #e11d48;
  --rose-light: #ffe4e6;
  --warn: #d97706;
  --warn-bg: #fffbeb;
  --warn-border: #fde68a;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); line-height:1.55; }

/* ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê */
.topbar { background:linear-gradient(135deg,#1e293b,#334155); color:white; position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(0,0,0,0.15); }
.topbar-inner { max-width:1000px; margin:0 auto; padding:0.9rem 1.5rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
.topbar-title { font-family:'Fraunces',serif; font-size:1.15rem; font-weight:700; }
.topbar-sub { font-size:0.8rem; opacity:0.6; }
.mode-toggle { display:flex; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.15); }
.mode-btn { padding:0.5rem 1.1rem; border:none; background:transparent; color:rgba(255,255,255,0.65); font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.mode-btn:first-child { background:rgba(5,150,105,0.35); }
.mode-btn:first-child.active { background:#059669; color:white; }
.mode-btn:last-child { background:rgba(37,99,235,0.35); }
.mode-btn:last-child.active { background:#2563eb; color:white; }

.main { max-width:1000px; margin:0 auto; padding:1.5rem; }

/* ‚ïê‚ïê‚ïê TEACHER ‚ïê‚ïê‚ïê */
.teacher-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.75rem; margin-bottom:1.25rem; }
.teacher-header h2 { font-family:'Fraunces',serif; font-size:1.3rem; font-weight:700; }
.week-row { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
.week-row label { font-size:0.85rem; font-weight:600; color:var(--muted); }
.week-row input,.week-row select { padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:6px; font-family:'DM Sans',sans-serif; font-size:0.85rem; background:var(--card); }
.week-row input[type=number] { width:70px; }

.info-section { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1rem; margin-bottom:1rem; }
.info-section h3 { font-size:0.85rem; font-weight:700; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.4rem; }

/* Auto-expanding textarea */
.auto-textarea {
  width:100%; min-height:60px; padding:0.6rem 0.75rem;
  border:1px solid var(--border); border-radius:6px;
  font-family:'DM Sans',sans-serif; font-size:0.88rem; line-height:1.5;
  resize:none; overflow:hidden;
  background:#fafaf8; field-sizing:content;
}
.auto-textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }

/* Calendar */
.cal-grid { display:grid; grid-template-columns:60px repeat(5,1fr); gap:0.35rem; margin-top:0.5rem; }
.cal-grid .cal-header { font-size:0.72rem; font-weight:700; text-transform:uppercase; color:var(--muted); padding:0.25rem; text-align:center; }
.cal-grid input { width:100%; padding:0.3rem 0.4rem; border:1px solid var(--border-lt); border-radius:4px; font-family:'DM Sans',sans-serif; font-size:0.8rem; text-align:center; }
.cal-grid input:focus { outline:none; border-color:var(--accent); }
.cal-wk { display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.82rem; color:var(--muted); }

/* ‚ïê‚ïê‚ïê SUBJECT CARDS (teacher) ‚ïê‚ïê‚ïê */
.scard { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:0.75rem; overflow:hidden; transition:box-shadow 0.2s; }
.scard:hover { box-shadow:var(--shadow-md); }
.scard-head { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; cursor:pointer; user-select:none; transition:background 0.15s; }
.scard-head:hover { background:#faf9f7; }
.scard-left { display:flex; align-items:center; gap:0.6rem; }
.scard-chev { color:var(--muted); transition:transform 0.25s; font-size:0.85rem; }
.scard.open .scard-chev { transform:rotate(180deg); }
.scard-body { display:none; padding:0 1rem 1rem; border-top:1px solid var(--border-lt); }
.scard.open .scard-body { display:block; }

/* Group columns */
.groups-area { margin-top:0.65rem; }
.groups-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.85rem; }
.group-col {
  border:1px solid var(--border-lt); border-radius:var(--radius-sm);
  padding:0.85rem; position:relative;
  transition: box-shadow 0.2s;
}
.group-col:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
@media(max-width:700px){ .groups-grid{grid-template-columns:1fr} }

.gc-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.65rem; gap:0.4rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border-lt); }
.gc-name-input {
  font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:700;
  padding:0.25rem 0.5rem; border:1px solid transparent; border-radius:4px;
  background:transparent; flex:1; min-width:0;
  text-transform:uppercase; letter-spacing:0.03em;
}
.gc-name-input:hover { border-color:var(--border); }
.gc-name-input:focus { outline:none; border-color:var(--accent); background:white; }

.gc-delete {
  width:24px; height:24px; border:none; background:transparent;
  color:var(--muted); font-size:1rem; cursor:pointer; border-radius:4px;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; flex-shrink:0;
}
.gc-delete:hover { background:#fee2e2; color:#dc2626; }

.gc-color-stripe {
  position:absolute; top:0; left:0; right:0; height:4px; border-radius:8px 8px 0 0;
}

/* Copy button */
.gc-copy-btn {
  border:none; background:transparent; color:var(--muted);
  font-size:0.7rem; font-family:'DM Sans',sans-serif; font-weight:600;
  cursor:pointer; padding:0.2rem 0.4rem; border-radius:4px;
  transition:all 0.15s; white-space:nowrap;
}
.gc-copy-btn:hover { background:var(--accent-light); color:var(--accent); }

.sfield { margin-bottom:0.7rem; }
.slabel {
  display:flex; align-items:center; gap:0.3rem;
  font-size:0.76rem; font-weight:700; color:#4a5568;
  margin-bottom:0.35rem; letter-spacing:0.01em;
}
.slabel-icon { font-size:0.8rem; flex-shrink:0; }
.sinput {
  width:100%; padding:0.45rem 0.6rem; border:1.5px solid #d2d6dc;
  border-radius:6px; font-family:'DM Sans',sans-serif; font-size:0.84rem;
  background:#f0f4f8; transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
}
.sinput::placeholder { color:#a0aec0; font-weight:400; }
.sinput:hover { border-color:#cbd5e0; background:#f7fafc; }
.sinput:focus { outline:none; border-color:var(--accent); background:white; box-shadow:0 0 0 3px rgba(37,99,235,0.08); }
textarea.sinput { min-height:50px; resize:none; overflow:hidden; line-height:1.45; field-sizing:content; }
textarea.sinput.hw-field { min-height:80px; }

/* Label row with copy button */
.slabel-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.35rem; }
.slabel-row .slabel { margin-bottom:0; }

/* Fristdag field ‚Äì visually distinct */
.sfield-frist { margin-bottom:0.4rem; padding-top:0.5rem; border-top:1px dashed var(--border-lt); }

.add-group-btn {
  display:flex; align-items:center; justify-content:center; gap:0.35rem;
  min-width:120px; min-height:80px;
  border:2px dashed var(--border); border-radius:var(--radius-sm);
  background:transparent; font-family:'DM Sans',sans-serif;
  font-size:0.82rem; font-weight:600; color:var(--muted);
  cursor:pointer; transition:all 0.2s; padding:0.75rem;
  align-self:stretch;
}
.add-group-btn:hover { border-color:var(--accent); color:var(--accent); background:#f8faff; }

/* Shared fields row */
.shared-row { margin-top:0.65rem; padding-top:0.6rem; border-top:1px solid var(--border-lt); }

/* Action bar */
.action-bar { display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1.25rem; padding-top:1rem; border-top:1px solid var(--border); }
.btn { padding:0.6rem 1.3rem; border:none; border-radius:var(--radius-sm); font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
.btn-primary { background:var(--accent); color:white; }
.btn-primary:hover { background:#1d4ed8; }
.btn-secondary { background:var(--card); color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover { background:#f5f3ef; }
.btn-green { background:var(--green); color:white; }
.btn-green:hover { background:#047857; }

/* Tags */
.stag {
  font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.05em;
  padding:0.2rem 0.55rem; border-radius:4px; white-space:nowrap;
  display:inline-block; text-align:center; min-width:160px;
}

/* ‚ïê‚ïê‚ïê PRINT STYLES ‚ïê‚ïê‚ïê */
@media print {
  .topbar, .group-picker, .print-btn, .toast { display:none !important; }
  .main { padding:0.5rem; max-width:100%; }
  
  /* Print header visible on all pages */
  .print-header {
    display: block !important;
    padding: 0.3rem 1rem;
    background: white;
    border-bottom: 2px solid #2563eb;
    font-family: 'Fraunces', serif;
    font-size: 0.85rem;
    font-weight: 700;
    color: #1a1a1a;
    text-align: center;
    margin-bottom: 0.35rem;
  }
  
  /* Second print header on page 2 */
  .print-header-page2 {
    page-break-before: always;
    margin-top: 0;
    padding-top: 0;
  }
  
  /* Hide screen header elements on print */
  .p-header h2, .p-header .ph-sub, .p-header > div[style*="font-size"] { display: none !important; }
  
  /* Calendar at top of page 1 - compact */
  .p-calendar {
    margin-bottom: 0.2rem;
    order: -1; /* Move calendar to top */
  }
  .p-cal-table {
    font-size: 0.58rem;
    border-collapse: separate;
    border-spacing: 0;
  }
  .p-cal-table th, .p-cal-table td {
    padding: 0.1rem 0.2rem;
    border: 1px solid #cbd5e1;
    line-height: 1.1;
  }
  .p-cal-table th {
    background: #f1f5f9;
    font-weight: 700;
  }
  .p-cal-table td:first-child {
    background: #f8fafc;
    font-weight: 700;
  }

  /* Alerts at bottom of page 1 - compact */
  .p-alerts {
    margin-bottom: 0.3rem;
    order: 10; /* Move alerts to bottom */
  }
  .p-alert { padding: 0.2rem 0.4rem; font-size: 0.62rem; margin-bottom: 0.1rem; line-height: 1.25; }

  /* Equipment list - vertical layout */
  .equip-strip {
    margin-bottom: 0.3rem;
    padding: 0.35rem 0.5rem;
    order: 5;
  }
  .equip-strip h3 { font-size: 0.72rem; margin-bottom: 0.15rem; }
  .equip-list {
    display: flex;
    flex-direction: column !important;
    gap: 0.1rem !important;
  }
  .equip-chip {
    font-size: 0.62rem;
    padding: 0.15rem 0.35rem;
    display: block !important;
    width: 100%;
  }
  
  /* Page 1 structure - show header */
  .p-header {
    display: block !important;
    margin-bottom: 0.25rem;
  }
  .p-header h2, .p-header .ph-sub { display: none !important; }
  .p-header > div[style*="font-size"] { display: none !important; }
  
  /* Calendar - fixed column widths, compact for print */
  .p-calendar {
    margin-bottom: 0.2rem;
  }
  .p-cal-table {
    font-size: 0.58rem;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    table-layout: fixed;
  }
  .p-cal-table th, .p-cal-table td {
    padding: 0.1rem 0.2rem;
    border: 1px solid #cbd5e1;
    line-height: 1.1;
  }
  .p-cal-table th:first-child,
  .p-cal-table td:first-child {
    width: 40px;
  }
  .p-cal-table th {
    background: #f1f5f9;
    font-weight: 700;
  }
  .p-cal-table td:first-child {
    background: #f8fafc;
    font-weight: 700;
  }
  
  /* Equipment list - vertical layout, compact */
  .equip-strip {
    margin-bottom: 0.3rem;
    padding: 0.35rem 0.5rem;
  }
  .equip-strip h3 { font-size: 0.72rem; margin-bottom: 0.15rem; }
  .equip-list {
    display: flex;
    flex-direction: column !important;
    gap: 0.1rem !important;
  }
  .equip-chip {
    font-size: 0.62rem;
    padding: 0.15rem 0.35rem;
  }
  
  /* Alerts after equipment - compact */
  .p-alerts {
    margin-bottom: 0.3rem;
  }
  .p-alert { padding: 0.2rem 0.4rem; font-size: 0.62rem; margin-bottom: 0.1rem; line-height: 1.25; }

  /* Class name colors in header */
  .print-header .class-8a { color: #dc2626; font-weight: 800; }
  .print-header .class-8b { color: #2563eb; font-weight: 800; }
  
  /* Page 2: Stronger separators between days */
  .day-block {
    margin-bottom: 0.35rem;
    page-break-inside: avoid;
    border: 2px solid #1e293b;
    border-radius: 6px;
    padding: 0.3rem;
    background: white;
  }
  
  /* Alternating soft background colors for days */
  /* Note: print-header-page2 is first child, so day blocks start at nth-child(2) */
  .day-block:nth-child(2) { 
    background: #fef3c7 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  } /* Mandag - soft yellow */
  .day-block:nth-child(3) { 
    background: #dbeafe !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  } /* Tirsdag - soft blue */
  .day-block:nth-child(4) { 
    background: #dcfce7 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  } /* Onsdag - soft green */
  .day-block:nth-child(5) { 
    background: #fce7f3 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  } /* Torsdag - soft pink */
  .day-block:nth-child(6) { 
    background: #e0e7ff !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  } /* Fredag - soft purple */
  
  .day-strip {
    margin-bottom: 0.4rem;
    padding-bottom: 0.3rem;
    border-bottom: 3px solid #1e293b;
    background: rgba(255,255,255,0.7);
    padding: 0.25rem 0.4rem;
    border-radius: 4px;
    margin: -0.3rem -0.3rem 0.4rem -0.3rem;
  }
  .day-lbl {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .day-dt {
    font-size: 0.68rem;
    opacity: 0.8;
  }
  
  /* Align homework cards with flexbox */
  .hw-card {
    margin-bottom: 0.25rem;
    padding: 0.3rem 0.4rem;
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
    border: 1.5px solid #94a3b8;
    border-radius: 4px;
    background: white;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  /* Checkbox for students */
  .hw-checkbox {
    width: 16px;
    height: 16px;
    border: 2px solid #475569;
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 2px;
    background: white;
  }
  .hw-tag {
    font-size: 0.6rem;
    padding: 0.15rem 0.35rem;
    min-width: 95px;
    max-width: 95px;
    text-align: center;
    flex-shrink: 0;
    font-weight: 700;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .hw-body { flex: 1; }
  .hw-body-text {
    font-size: 0.68rem;
    line-height: 1.3;
    font-weight: 500;
  }
  .hw-empty { font-size: 0.65rem; padding: 0.3rem; }

  /* Merged homework card ‚Äì teacher sub-lines */
  .hw-subline {
    margin-bottom: 0.15rem;
    display: flex;
    align-items: flex-start;
    gap: 0.35rem;
  }
  .hw-subline:last-child { margin-bottom: 0; }
  .hw-teacher-tag {
    font-size: 0.55rem;
    font-weight: 700;
    padding: 0.08rem 0.3rem;
    border-radius: 3px;
    white-space: nowrap;
    flex-shrink: 0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .hw-subline .hw-body-text {
    font-size: 0.63rem;
  }

  /* Footer - only show in print */
  .print-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 0.6rem;
    color: #64748b;
    padding: 0.5rem;
    border-top: 1px solid #e2ddd5;
    background: white;
  }
}
.t-matte{background:#fef08a;color:#854d0e}.t-norsk{background:#fecaca;color:#991b1b}
.t-engelsk{background:#a7f3d0;color:#065f46}.t-samf{background:#bfdbfe;color:#1e3a8a}
.t-krle{background:#f5d0fe;color:#86198f}.t-naturfag{background:#86efac;color:#14532d}
.t-kh{background:#fed7aa;color:#9a3412}.t-musikk{background:#fbcfe8;color:#9d174d}
.t-sprak{background:#7dd3fc;color:#0c4a6e}.t-gym{background:#d8b4fe;color:#581c87}
.t-svomming{background:#67e8f9;color:#164e63}.t-alf{background:#d9f99d;color:#365314}
.t-valgfag{background:#d4d4d8;color:#3f3f46}

/* Subject header backgrounds (lighter tints) */
.scard-head.sh-matte{background:#fefce8}.scard-head.sh-matte:hover{background:#fef9c3}
.scard-head.sh-norsk{background:#fef2f2}.scard-head.sh-norsk:hover{background:#fee2e2}
.scard-head.sh-engelsk{background:#ecfdf5}.scard-head.sh-engelsk:hover{background:#d1fae5}
.scard-head.sh-samf{background:#eff6ff}.scard-head.sh-samf:hover{background:#dbeafe}
.scard-head.sh-krle{background:#fdf4ff}.scard-head.sh-krle:hover{background:#fae8ff}
.scard-head.sh-naturfag{background:#f0fdf4}.scard-head.sh-naturfag:hover{background:#dcfce7}
.scard-head.sh-kh{background:#fff7ed}.scard-head.sh-kh:hover{background:#ffedd5}
.scard-head.sh-musikk{background:#fdf2f8}.scard-head.sh-musikk:hover{background:#fce7f3}
.scard-head.sh-sprak{background:#f0f9ff}.scard-head.sh-sprak:hover{background:#e0f2fe}
.scard-head.sh-gym{background:#faf5ff}.scard-head.sh-gym:hover{background:#f3e8ff}
.scard-head.sh-svomming{background:#ecfeff}.scard-head.sh-svomming:hover{background:#cffafe}
.scard-head.sh-alf{background:#f7fee7}.scard-head.sh-alf:hover{background:#ecfccb}
.scard-head.sh-valgfag{background:#f4f4f5}.scard-head.sh-valgfag:hover{background:#e4e4e7}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARENT VIEW
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.p-header { text-align:center; margin-bottom:1.25rem; }
.p-header h2 { font-family:'Fraunces',serif; font-size:1.6rem; font-weight:800; letter-spacing:-0.02em; }
.p-header .ph-sub { color:var(--muted); font-size:0.9rem; margin-top:0.15rem; }

.group-picker { display:flex; justify-content:center; margin-bottom:1.25rem; }
.gp-wrap { display:flex; flex-wrap:wrap; gap:0.35rem; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:0.3rem; box-shadow:var(--shadow-md); }
.gp-btn {
  padding:0.55rem 1.2rem; border:none; background:transparent;
  font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:600;
  cursor:pointer; color:var(--muted); border-radius:8px; transition:all 0.2s;
}
.gp-btn.sel { background:var(--accent); color:white; }

.p-alerts { display:flex; flex-direction:column; gap:0.4rem; margin-bottom:1rem; }
.p-alert { display:flex; align-items:flex-start; gap:0.5rem; padding:0.65rem 0.9rem; border-radius:var(--radius-sm); border:1px solid var(--warn-border); background:var(--warn-bg); font-size:0.87rem; }

.p-calendar { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow-x:auto; margin-bottom:1rem; }
.p-cal-table { width:100%; border-collapse:collapse; font-size:0.82rem; min-width:500px; }
.p-cal-table th { padding:0.5rem 0.6rem; background:#faf9f7; font-weight:700; text-align:center; border-bottom:2px solid var(--border); font-size:0.78rem; text-transform:uppercase; color:var(--muted); }
.p-cal-table th:first-child { width:55px; }
.p-cal-table td { padding:0.4rem 0.5rem; text-align:center; border-bottom:1px solid var(--border-lt); }
.p-cal-table td:first-child { font-weight:700; color:var(--muted); }
.p-cal-table td.has-ev { font-weight:600; color:var(--accent); }

.day-block { margin-bottom:0.9rem; }
.day-strip { display:flex; align-items:center; gap:0.65rem; margin-bottom:0.4rem; }
.day-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); flex-shrink:0; }
.day-lbl { font-family:'Fraunces',serif; font-weight:600; font-size:1.05rem; }
.day-dt { font-size:0.82rem; color:var(--muted); }
.day-rule { flex:1; height:1px; background:var(--border); }
.hw-cards { display:flex; flex-direction:column; gap:0.4rem; }
.hw-card { display:flex; gap:0.75rem; align-items:flex-start; padding:0.7rem 0.85rem; background:var(--card); border:1px solid var(--border); border-radius:var(--radius-sm); }
.hw-tag { font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.04em; padding:0.15rem 0.45rem; border-radius:4px; white-space:nowrap; flex-shrink:0; margin-top:2px; }
.hw-body { flex:1; }
.hw-body-text { font-size:0.88rem; }
.hw-body-meta { font-size:0.76rem; color:var(--muted); margin-top:0.15rem; }
.hw-empty { padding:0.9rem; text-align:center; color:var(--muted); font-size:0.88rem; background:var(--card); border:1px dashed var(--border); border-radius:var(--radius-sm); }

/* Merged homework card (multiple groups in one card) */
.hw-subline { margin-bottom:0.3rem; display:flex; align-items:flex-start; gap:0.4rem; }
.hw-subline:last-child { margin-bottom:0; }
.hw-teacher-tag {
  font-size:0.65rem; font-weight:700; padding:0.1rem 0.4rem;
  border-radius:3px; white-space:nowrap; flex-shrink:0; margin-top:1px;
}
/* Inverted tag colors for teacher names */
.t-matte-inv{background:#854d0e;color:#fef08a}
.t-norsk-inv{background:#991b1b;color:#fecaca}
.t-engelsk-inv{background:#065f46;color:#a7f3d0}
.t-samf-inv{background:#1e3a8a;color:#bfdbfe}
.t-krle-inv{background:#86198f;color:#f5d0fe}
.t-naturfag-inv{background:#14532d;color:#86efac}
.t-kh-inv{background:#9a3412;color:#fed7aa}
.t-musikk-inv{background:#9d174d;color:#fbcfe8}
.t-sprak-inv{background:#0c4a6e;color:#7dd3fc}
.t-gym-inv{background:#581c87;color:#d8b4fe}
.t-svomming-inv{background:#164e63;color:#67e8f9}
.t-alf-inv{background:#365314;color:#d9f99d}
.t-valgfag-inv{background:#3f3f46;color:#d4d4d8}

.equip-strip { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:0.75rem 1rem; margin-bottom:1rem; }
.equip-strip h3 { font-size:0.78rem; font-weight:700; text-transform:uppercase; color:var(--muted); margin-bottom:0.35rem; }
.equip-list { display:flex; flex-wrap:wrap; gap:0.35rem; }
.equip-chip { display:inline-flex; align-items:center; gap:0.3rem; font-size:0.8rem; padding:0.2rem 0.6rem; background:#f1f0ec; border-radius:4px; font-weight:500; }

/* Toast */
.toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(100px); background:#1e293b; color:white; padding:0.75rem 1.5rem; border-radius:var(--radius); font-weight:600; font-size:0.88rem; box-shadow:var(--shadow-md); transition:transform 0.3s ease; z-index:200; }
.toast.show { transform:translateX(-50%) translateY(0); }

/* Footer - visible on screen and print */
.page-footer {
  text-align: center;
  font-size: 0.7rem;
  color: #64748b;
  padding: 1rem;
  margin-top: 1.5rem;
  border-top: 1px solid #e2ddd5;
}
.page-footer a {
  color: #2563eb;
  text-decoration: none;
}
.page-footer a:hover {
  text-decoration: underline;
}
@media print {
  .page-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    margin-top: 0;
    padding: 0.4rem;
    font-size: 0.6rem;
    background: white;
    border-top: 1px solid #e2ddd5;
  }
}

/* Timetable styles - only show on print */
.timetable-section {
  display: none !important;
}

/* Print */
@media print {
  body{background:white}
  .topbar{position:static;background:#1e293b!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .mode-toggle{display:none}
  .hw-tag,.stag,.p-alert,.equip-chip,.gp-btn.sel,.hw-teacher-tag{-webkit-print-color-adjust:exact;print-color-adjust:exact}

  /* Show timetable in print - compact */
  .timetable-section {
    display: block !important;
    margin-bottom: 0.35rem;
    page-break-inside: avoid;
    visibility: visible !important;
    opacity: 1 !important;
  }
  .timetable-section h3 {
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 0.15rem;
    text-align: center;
    color: #1a1a1a;
  }
  .timetable {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0.2rem;
    visibility: visible !important;
  }
  .timetable th {
    background: #1e40af !important;
    color: white !important;
    font-weight: 700;
    padding: 0.2rem 0.25rem;
    border: 1px solid #1e3a8a;
    text-align: center;
    font-size: 0.64rem;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable td {
    padding: 0.2rem 0.2rem;
    border: 1px solid #cbd5e1 !important;
    text-align: center;
    vertical-align: middle;
    font-size: 0.62rem;
    height: 40px;
    line-height: 1.2;
  }
  .timetable .time {
    display: block !important;
    font-size: 0.52rem;
    font-weight: 600;
    margin-bottom: 0.08rem;
    color: #1e293b !important;
  }
  .timetable .subject {
    display: block !important;
    font-weight: 700;
    font-size: 0.62rem;
    color: #1a1a1a !important;
  }
  .timetable .break-cell {
    background: white !important;
    font-weight: 700;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .norsk-cell {
    background: #fecaca !important;
    color: #991b1b !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .samfunnsfag-cell {
    background: #bfdbfe !important;
    color: #1e3a8a !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .naturfag-cell {
    background: #86efac !important;
    color: #14532d !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .matte-cell {
    background: #fef08a !important;
    color: #854d0e !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .engelsk-cell {
    background: #a7f3d0 !important;
    color: #065f46 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .kh-cell {
    background: #fed7aa !important;
    color: #9a3412 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .sprak-cell {
    background: #7dd3fc !important;
    color: #0c4a6e !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .krle-cell {
    background: #f5d0fe !important;
    color: #86198f !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .gym-cell {
    background: #d8b4fe !important;
    color: #581c87 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .svomming-cell {
    background: #67e8f9 !important;
    color: #164e63 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .musikk-cell {
    background: #fbcfe8 !important;
    color: #9d174d !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .valgfag-cell {
    background: #d4d4d8 !important;
    color: #3f3f46 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
  .timetable .klassens-cell {
    background: #ede9fe !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }

  /* Tema/M√•l section - compact */
  .tema-section {
    margin-bottom: 0.3rem;
    page-break-inside: avoid;
    border: 2px solid #1e293b;
    border-radius: 6px;
    padding: 0.2rem;
    background: white;
  }
  .tema-section h3 {
    font-size: 0.7rem;
    font-weight: 700;
    margin-bottom: 0.15rem;
    text-align: center;
    color: #1a1a1a;
  }
  .tema-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.6rem;
  }
  .tema-table tr {
    border-bottom: 1px solid #e2ddd5;
  }
  .tema-table tr:last-child {
    border-bottom: none;
  }
  .tema-subject {
    font-weight: 700;
    padding: 0.2rem 0.4rem;
    width: 140px;
    min-width: 140px;
    max-width: 140px;
    text-align: center;
    font-size: 0.55rem;
    line-height: 1.15;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  .tema-text {
    padding: 0.2rem 0.35rem;
    line-height: 1.25;
  }

  /* Compact mode for many homework items (15+) */
  .hw-compact .day-block {
    margin-bottom: 0.35rem;
    padding: 0.3rem;
  }
  .hw-compact .day-strip {
    margin: -0.25rem -0.25rem 0.3rem -0.25rem;
    padding: 0.2rem 0.3rem;
  }
  .hw-compact .day-lbl {
    font-size: 0.9rem;
  }
  .hw-compact .day-dt {
    font-size: 0.6rem;
  }
  .hw-compact .hw-card {
    margin-bottom: 0.25rem;
    padding: 0.3rem 0.4rem;
    gap: 0.5rem;
  }
  .hw-compact .hw-checkbox {
    width: 14px;
    height: 14px;
  }
  .hw-compact .hw-tag {
    font-size: 0.58rem;
    padding: 0.15rem 0.35rem;
    min-width: 75px;
    max-width: 75px;
  }
  .hw-compact .hw-body-text {
    font-size: 0.65rem;
    line-height: 1.3;
  }
  .hw-compact .hw-empty {
    font-size: 0.62rem;
    padding: 0.3rem;
  }
  .hw-compact .hw-subline {
    margin-bottom: 0.1rem;
    gap: 0.25rem;
  }
  .hw-compact .hw-teacher-tag {
    font-size: 0.5rem;
    padding: 0.05rem 0.25rem;
  }
  .hw-compact .hw-subline .hw-body-text {
    font-size: 0.58rem;
  }
  .hw-compact .tema-section {
    margin-bottom: 0.4rem;
    padding: 0.3rem;
  }
  .hw-compact .tema-section h3 {
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
  }
  .hw-compact .tema-table {
    font-size: 0.62rem;
  }
  .hw-compact .tema-subject {
    padding: 0.25rem 0.5rem;
    font-size: 0.54rem;
  }
  .hw-compact .tema-text {
    padding: 0.22rem 0.35rem;
    line-height: 1.3;
  }
}
@media(max-width:700px){
  .main{padding:1rem}
  .groups-grid{grid-template-columns:1fr}
  .topbar-inner{flex-direction:column;align-items:flex-start}
}

@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn 0.25s ease both}

/* Print header - hidden on screen, visible on print */
.print-header { display: none; }

/* Auth screen */
#auth-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.auth-box {
  background: white;
  padding: 2rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  max-width: 400px;
  width: 90%;
}
.auth-box h2 {
  font-family: 'Fraunces', serif;
  color: var(--accent);
  margin-bottom: 1.5rem;
  text-align: center;
}
.auth-input {
  width: 100%;
  padding: 0.75rem;
  margin-bottom: 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
}
.auth-btn {
  width: 100%;
  padding: 0.75rem;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 0.5rem;
}
.auth-btn:hover {
  background: #1d4ed8;
}
.auth-link {
  text-align: center;
  color: var(--muted);
  font-size: 0.9rem;
  margin-top: 1rem;
}
.auth-link a {
  color: var(--accent);
  cursor: pointer;
  text-decoration: underline;
}
.auth-error {
  background: #fee;
  color: #c00;
  padding: 0.5rem;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  margin-bottom: 1rem;
  display: none;
}
.user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  color: rgba(255,255,255,0.7);
  white-space: nowrap;
  flex-shrink: 1;
  min-width: 0;
}
.user-info span {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  min-width: 0;
}
.user-info button {
  padding: 0.35rem 0.75rem;
  background: rgba(255,255,255,0.15);
  color: white;
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 4px;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  transition: background 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}
.user-info button:hover {
  background: rgba(255,255,255,0.25);
}
@media print {
  .user-info { display: none !important; }
}
</style>

<!-- Firebase SDK (Compat version for easier use) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAwjFwTH-2KZ1qovSK_cNq5Ta63xPpFblY",
  authDomain: "lunner-ukeplaner.firebaseapp.com",
  projectId: "lunner-ukeplaner",
  storageBucket: "lunner-ukeplaner.firebasestorage.app",
  messagingSenderId: "112862562417",
  appId: "1:112862562417:web:89ab19e7347edeed57f3d0"
};

// Check if Firebase is loaded
if (typeof firebase === 'undefined') {
  console.error('Firebase SDK not loaded!');
  alert('Firebase kunne ikke lastes. Sjekk internettforbindelsen.');
} else {
  firebase.initializeApp(firebaseConfig);
  window.auth = firebase.auth();
  window.db = firebase.firestore();
  console.log('Firebase initialized successfully');
}
</script>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-box">
    <h2>üéì Lunner Ukeplaner</h2>
    <div id="auth-error" class="auth-error"></div>

    <div id="login-form">
      <input type="email" id="login-email" class="auth-input" placeholder="E-post" onkeypress="if(event.key==='Enter') handleLogin()">
      <input type="password" id="login-password" class="auth-input" placeholder="Passord" onkeypress="if(event.key==='Enter') handleLogin()">
      <button class="auth-btn" onclick="handleLogin()">Logg inn</button>
    </div>
  </div>
</div>

<div class="topbar">
  <div class="topbar-inner">
    <div>
      <div class="topbar-title" id="topbar-title">Ukeplan ‚Äì Uke 7</div>
      <div class="topbar-sub">Lunner ungdomsskole ¬∑ 8. trinn</div>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" onclick="setMode('teacher')">‚úèÔ∏è Rediger ukeplan</button>
      <button class="mode-btn" onclick="setMode('parent')">üñ®Ô∏è Utskrift / Lagring</button>
    </div>
    <!-- User info (shown when logged in) -->
    <div id="user-info" class="user-info" style="display:none">
      <span id="user-email"></span>
      <button onclick="handleLogout()">Logg ut</button>
    </div>
  </div>
</div>

<div class="main">
  <div id="teacher-view">
    <div class="teacher-header">
      <h2>Rediger ukeplan</h2>
      <div class="week-row">
        <label>Uke</label>
        <input type="number" id="weekNum" value="7" min="1" max="52" onchange="updWeekNum()">
        <label>Fra</label>
        <input type="date" id="weekStart" value="2026-02-09" onchange="updDateOnly()">
        <label>Til</label>
        <input type="date" id="weekEnd" value="2026-02-13" onchange="updDateOnly()">
      </div>
    </div>

    <div class="info-section">
      <h3>üì¢ Viktig informasjon</h3>
      <textarea class="auto-textarea" id="infoText">Husk bokbind p√• ALLE b√∏ker! Det er fremdeles noen som mangler.
8A: Pr√∏ve i samfunnsfag onsdag.
Sv√∏mming mandag: Jentene sv√∏mmer f√∏rst (oddetallsuke).
8B: Kropps√∏ving ‚Äì sk√∏yter, ta med utekl√¶r, lue og hansker.</textarea>
    </div>

    <div class="info-section">
      <h3>üìÖ Ukeoversikt fremover</h3>
      <div class="cal-grid">
        <div class="cal-header">Uke</div><div class="cal-header">Man</div><div class="cal-header">Tir</div><div class="cal-header">Ons</div><div class="cal-header">Tor</div><div class="cal-header">Fre</div>
        <div class="cal-wk" id="wk0">7</div><input id="c00"><input id="c01"><input id="c02"><input id="c03"><input id="c04">
        <div class="cal-wk" id="wk1">8</div><input id="c10"><input id="c11"><input id="c12"><input id="c13"><input id="c14">
        <div class="cal-wk" id="wk2">9</div><input id="c20"><input id="c21"><input id="c22"><input id="c23"><input id="c24">
        <div class="cal-wk" id="wk3">10</div><input id="c30"><input id="c31"><input id="c32"><input id="c33"><input id="c34">
      </div>
    </div>

    <div id="subject-forms"></div>

    <div class="page-footer">Gaute Eltvik Dyrnes ¬∑ Lunner ungdomsskole ¬∑ <a href="mailto:gaute.dyrnes@lunnerskole.no">gaute.dyrnes@lunnerskole.no</a> ¬∑ ¬© <script>document.write(new Date().getFullYear())</script></div>
  </div>

  <div id="parent-view" style="display:none"></div>
</div>

<div class="toast" id="toast">Lagret!</div>

<script>
const DAYS = ['Mandag','Tirsdag','Onsdag','Torsdag','Fredag'];
const GROUP_COLORS = ['#2563eb','#059669','#ea580c','#7c3aed','#e11d48','#0891b2','#ca8a04','#6d28d9'];

// Calendar data structure - stores events by week number
const calendarData = {
  7: ['', '', '8A: Pr√∏ve samf.', '', ''],
  8: ['Vinterferie', 'Vinterferie', 'Vinterferie', 'Vinterferie', 'Vinterferie'],
  9: ['', '', 'Fransk: Muntlig h√∏ring', '', ''],
  10: ['', 'Fransk: Muntlig h√∏ring', '', '', ''],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUBJECT DATA MODEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Each subject has an array of groups. Default is 8A/8B.
// Matte has 5 groups as example.
const subjects = [
  { id:'matte', name:'Matematikk', tag:'t-matte',
    groups:[
      { name:'Thomas 8', teachers:'Thomas', tema:'Algebra ‚Äì algebraiske uttrykk, addisjon/subtraksjon', hw:'Gj√∏r utdelt arbeidsark.', day:'Onsdag', color:0 },
      { name:'Sandra 8', teachers:'Sandra', tema:'Algebra ‚Äì algebraiske uttrykk, addisjon/subtraksjon', hw:'Gj√∏r utdelt arbeidsark.', day:'Onsdag', color:1 },
      { name:'Veslem√∏y 8', teachers:'Veslem√∏y', tema:'Algebra ‚Äì algebraiske uttrykk, sette inn verdier, lage uttrykk', hw:'Oppgavebok: 3.125 s.121, 3.130 s.123, 3.134 s.125, 3.137 s.126. Velg 1, 2 eller 3 prikker.', day:'Onsdag', color:2 },
      { name:'Amund 8', teachers:'Amund', tema:'Algebra ‚Äì addisjon/subtraksjon, multiplikasjon/divisjon, potenser', hw:'Oppgavebok: 3.120 s.119 (alle prikker), 3.138 s.126 (prikk 1‚Äì2), 3.126 s.122 (prikk 1‚Äì2).', day:'Onsdag', color:3 },
      { name:'Judith 8', teachers:'Judith', tema:'Grunnleggende regning', hw:'Jobb med arkene i permen. Husk BLYANT til alle timer.', day:'Onsdag', color:4 },
    ],
    equip:'Blyant til alle timer'
  },
  { id:'norsk', name:'Norsk', tag:'t-norsk',
    groups:[
      { name:'8A', teachers:'Siva, Tuva, Eivind', tema:'Les og Delta i debatten ‚Äì skrive appeller', hw:'Ingen lekse. Les 15 min hjemme daglig.', day:'', color:0 },
      { name:'8B', teachers:'B√∏rre, Ann Kristin', tema:'Les og Delta i debatten ‚Äì jobbe i boka', hw:'Forbered muntlig fremf√∏ring. Se s. 213‚Äì214 i Fabel 8. Husk √• levere debattinnlegg!', day:'Torsdag', color:1 },
    ],
    equip:'Fabel-bok, bibliotekbok til alle norsktimer'
  },
  { id:'engelsk', name:'Engelsk', tag:'t-engelsk',
    groups:[
      { name:'8A', teachers:'Siva, Tuva', tema:'Growing up ‚Äì ¬´Food for thought¬ª', hw:'Ingen lekse hvis dere jobber godt i timene.', day:'', color:0 },
      { name:'8B', teachers:'Gaute, P√•l', tema:'Growing up ‚Äì argumenterende tekst', hw:'Skriv ferdig argumenterende tekst (oppgave i Teams). Gj√∏r resten hjemme om du ikke rekker alt.', day:'Fredag', color:1 },
    ],
    equip:'Engelskbok p√• onsdag (8A)'
  },
  { id:'samf', name:'Samfunnsfag', tag:'t-samf',
    groups:[
      { name:'8A', teachers:'H√•kon, Siva', tema:'Den industrielle revolusjon', hw:'Til tirsdag: Fagbegreper (utdelt). Til onsdag: √òv til PR√òVE ‚Äì fagbegreper + boka s. 97‚Äì101.', day:'Onsdag', color:0 },
      { name:'8B', teachers:'Gaute, Eivind', tema:'Den industrielle revolusjon ‚Äì fabrikkbyer og arbeidsforhold', hw:'Les ¬´Fabrikkbyer og arbeidsforhold¬ª (SkolenMin). Skriv de fire punktene i skriveboka, IKKE digitalt.', day:'Tirsdag', color:1 },
    ],
    equip:''
  },
  { id:'krle', name:'KRLE', tag:'t-krle',
    groups:[
      { name:'8A', teachers:'H√•kon, Siva', tema:'Repetisjon verdensreligioner: Islam ‚Äì l√¶ringssti', hw:'Bli ferdig med l√¶ringsstien om Islam.', day:'Tirsdag', color:0 },
      { name:'8B', teachers:'Gaute, Eivind', tema:'Verdensreligioner ‚Äì g√• i dybden (Minecraft)', hw:'Jobb minst 20 min i Minecraft med de religi√∏se bygningene dine.', day:'Tirsdag', color:1 },
    ],
    equip:''
  },
  { id:'naturfag', name:'Naturfag', tag:'t-naturfag',
    groups:[
      { name:'8A', teachers:'Sandra, Veslem√∏y, Tuva', tema:'Vitenskap ‚Äì atommodeller', hw:'Tegn atommodeller i kladdeboka: hydrogen, helium, oksygen, nitrogen, natrium.', day:'Fredag', color:0 },
      { name:'8B', teachers:'Sandra, Ann Kristin, Espen', tema:'Vitenskap ‚Äì atommodeller', hw:'Tegn atommodeller i kladdeboka: hydrogen, helium, oksygen, nitrogen, natrium.', day:'Fredag', color:1 },
    ],
    equip:''
  },
  { id:'kh', name:'K&H', tag:'t-kh',
    groups:[
      { name:'Metallsl√∏yd', teachers:'Judith', tema:'Aluminium', hw:'', day:'', color:0 },
      { name:'Tresl√∏yd', teachers:'Espen', tema:'Tre som materiale ‚Äì oppstart skj√¶refj√∏l', hw:'', day:'', color:1 },
    ],
    equip:'Kl√¶r som t√•ler verksted, h√•rstrikk om n√∏dvendig'
  },
  { id:'musikk', name:'Musikk', tag:'t-musikk',
    groups:[
      { name:'8A', teachers:'Siva', tema:'Rytmer, takt, taktslag og samspill', hw:'', day:'', color:0 },
      { name:'8B', teachers:'Thomas', tema:'Rytmer, takt, taktslag og samspill ‚Äì bygger p√• uke 6', hw:'', day:'', color:1 },
    ],
    equip:''
  },
  { id:'sprak', name:'Spr√•klig fordypning', tag:'t-sprak',
    groups:[
      { name:'Spansk', teachers:'Doramas', tema:'Regelrette og uregelrette verb', hw:'', day:'', color:0 },
      { name:'Fransk', teachers:'P√•l', tema:'Kap 4 ‚Äì La famille, eiendomsord, telle til 50, avoir/√™tre', hw:'Gj√∏r ferdig oppgaver om eiendomsord i SkolenMin. Muntlig h√∏ring uke 9‚Äì10.', day:'Tirsdag', color:1 },
    ],
    equip:''
  },
  { id:'gym', name:'Kropps√∏ving', tag:'t-gym',
    groups:[
      { name:'8A', teachers:'H√•kon, Eivind', tema:'Volleyball (inne)', hw:'', day:'', color:0 },
      { name:'8B', teachers:'Ann Kristin, Eivind', tema:'Vinteraktiviteter ‚Äì sk√∏yter', hw:'', day:'', color:1 },
    ],
    equip:'8A: Innet√∏y og innesko. 8B: Utekl√¶r, lue, hansker.'
  },
  { id:'valgfag', name:'Valgfag', tag:'t-valgfag',
    groups:[
      { name:'Alle', teachers:'Diverse', tema:'Fysisk akt.: Vinteraktiviteter (ski). NMF: Sk√∏yter. D&R: Papp-prosjekt. Prog: Python. Prod: We are the World. Innsats: Lek med barnehagebarn. UPT: Fylkesmesse.', hw:'', day:'', color:0 },
    ],
    equip:'Utekl√¶r for utevalgfag'
  },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER TEACHER FORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderForms() {
  const wrap = document.getElementById('subject-forms');
  let html = '';

  subjects.forEach((s, si) => {
    const groupSummary = s.groups.map(g => g.name).join(', ');
    html += `<div class="scard" id="sc-${si}">
      <div class="scard-head sh-${s.id}" onclick="togSC(${si})">
        <div class="scard-left">
          <span class="stag ${s.tag}">${s.name}</span>
          <span style="font-size:0.82rem;color:var(--muted)">${groupSummary}</span>
        </div>
        <span class="scard-chev">‚ñæ</span>
      </div>
      <div class="scard-body">
        <div class="groups-area">
          <div class="groups-grid" id="gg-${si}">`;

    s.groups.forEach((g, gi) => {
      html += renderGroupCol(si, gi, g);
    });

    html += `<button class="add-group-btn" onclick="addGroup(${si})">+ Legg til gruppe</button>`;
    html += `</div></div>`;

    // Shared equip
    html += `<div class="shared-row">
      <div class="sfield">
        <label class="slabel"><span class="slabel-icon">üì¶</span> Utstyr √• ha med (alle grupper)</label>
        <input class="sinput" id="eq-${si}" value="${esc(s.equip || '')}" placeholder="F.eks. blyant, bok, utekl√¶r..." oninput="subjects[${si}].equip=this.value;saveToFirebase()">
      </div>
    </div>`;

    html += '</div></div>';
  });

  wrap.innerHTML = html;
  autoGrowAll();
}

function renderGroupCol(si, gi, g) {
  const color = GROUP_COLORS[g.color % GROUP_COLORS.length];
  const bgTint = color + '0a';
  const copyTemaBtn = gi > 0 ? `<button class="gc-copy-btn" onclick="copyField(${si},${gi-1},${gi},'tema')" title="Kopier tema/m√•l fra forrige gruppe">üìã Kopier tema/m√•l</button>` : '';
  const copyHwBtn = gi > 0 ? `<button class="gc-copy-btn" onclick="copyField(${si},${gi-1},${gi},'hw')" title="Kopier lekse fra forrige gruppe">üìã Kopier lekse</button>` : '';
  return `<div class="group-col" id="gc-${si}-${gi}" style="background:${bgTint}">
    <div class="gc-color-stripe" style="background:${color}"></div>
    <div class="gc-header">
      <input class="gc-name-input" value="${esc(g.name)}" onchange="updGroup(${si},${gi},'name',this.value)" style="color:${color}">
      <button class="gc-delete" onclick="delGroup(${si},${gi})" title="Slett gruppe">√ó</button>
    </div>
    <div class="sfield">
      <label class="slabel"><span class="slabel-icon">üë§</span> L√¶rere</label>
      <input class="sinput" value="${esc(g.teachers)}" placeholder="Skriv navn p√• l√¶rer..." oninput="updGroup(${si},${gi},'teachers',this.value)">
    </div>
    <div class="sfield">
      <div class="slabel-row"><label class="slabel"><span class="slabel-icon">üéØ</span> Tema / m√•l</label>${copyTemaBtn}</div>
      <textarea class="sinput" placeholder="Hva skal elevene l√¶re denne uken..." oninput="updGroup(${si},${gi},'tema',this.value)">${esc(g.tema)}</textarea>
    </div>
    <div class="sfield">
      <div class="slabel-row"><label class="slabel"><span class="slabel-icon">üìñ</span> Lekse</label>${copyHwBtn}</div>
      <textarea class="sinput hw-field" placeholder="Beskriv leksen..." oninput="updGroup(${si},${gi},'hw',this.value)">${esc(g.hw)}</textarea>
    </div>
    <div class="sfield sfield-frist">
      <label class="slabel"><span class="slabel-icon">üìÖ</span> Fristdag</label>
      <select class="sinput" style="min-height:auto" onchange="updGroup(${si},${gi},'day',this.value)">
        <option value="">Ingen lekse</option>
        ${DAYS.map(d => `<option value="${d}"${g.day===d?' selected':''}>${d}</option>`).join('')}
      </select>
    </div>
  </div>`;
}

function togSC(i) { document.getElementById('sc-'+i).classList.toggle('open'); }

function updGroup(si, gi, field, val) {
  subjects[si].groups[gi][field] = val;
  // If parent view is visible, re-render it to show changes immediately
  if (curMode === 'parent') {
    renderParent();
  }
}

function addGroup(si) {
  const s = subjects[si];
  const ci = s.groups.length;
  s.groups.push({ name:'Ny gruppe', teachers:'', tema:'', hw:'', day:'', color: ci });
  renderForms();
  document.getElementById('sc-'+si).classList.add('open');
  saveToFirebase();
}

function delGroup(si, gi) {
  if (subjects[si].groups.length <= 1) return showToast('M√• ha minst √©n gruppe');
  subjects[si].groups.splice(gi, 1);
  renderForms();
  document.getElementById('sc-'+si).classList.add('open');
  saveToFirebase();
}

function copyField(si, fromGi, toGi, field) {
  const src = subjects[si].groups[fromGi];
  const dest = subjects[si].groups[toGi];
  dest[field] = src[field];
  if (field === 'hw') dest.day = src.day; // Copy deadline too when copying homework
  renderForms();
  document.getElementById('sc-'+si).classList.add('open');
  saveToFirebase();
  const label = field === 'tema' ? 'Tema/m√•l' : 'Lekse';
  showToast(`${label} kopiert fra ${src.name}`);
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// Auto-grow textareas
function autoGrowAll() {
  document.querySelectorAll('.auto-textarea, textarea.sinput').forEach(ta => {
    ta.style.height = 'auto';
    ta.style.height = ta.scrollHeight + 'px';
    ta.addEventListener('input', function() { this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARENT VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selGroup = null; // selected group name

function getAllGroupNames() {
  // Count how many subjects each group name appears in
  const nameCount = {};
  subjects.forEach(s => {
    const seen = new Set();
    s.groups.forEach(g => {
      if (!seen.has(g.name)) {
        seen.add(g.name);
        nameCount[g.name] = (nameCount[g.name] || 0) + 1;
      }
    });
  });
  // Show groups that appear in at least 3 subjects (likely class groups, not subject-specific)
  const filtered = Object.keys(nameCount).filter(name => nameCount[name] >= 3);
  return filtered.sort((a, b) => a.localeCompare(b, 'no'));
}

function renderParent() {
  const wk = document.getElementById('weekNum').value;
  const ws = document.getElementById('weekStart').value;
  const we = document.getElementById('weekEnd').value;
  const info = document.getElementById('infoText').value;

  const allGroups = getAllGroupNames();
  if (!selGroup || !allGroups.includes(selGroup)) selGroup = allGroups[0] || '8A';

  const startDate = new Date(ws);
  const dates = [];
  for (let i=0; i<5; i++) { const d=new Date(startDate); d.setDate(d.getDate()+i); dates.push(`${d.getDate()}.${d.getMonth()+1}`); }

  let h = '';

  // Print header (fixed on all pages when printing)
  const classColor = selGroup === '8A' ? 'class-8a' : 'class-8b';
  h += `<div class="print-header">Informasjon uke ${wk} ‚Äì Klasse <span class="${classColor}">${selGroup}</span> ‚Äì Lunner ungdomsskole</div>`;

  // Header
  h += `<div class="p-header fade-in">
    <h2>Ukeplan ‚Äì Uke ${wk}</h2>
    <div class="ph-sub">${fmtRange(ws,we)} ¬∑ Lunner ungdomsskole ¬∑ 8. trinn</div>
    <div style="font-size:1.3rem; font-weight:700; color:var(--accent); margin-top:0.5rem; font-family:'Fraunces',serif;">Klasse: ${selGroup}</div>
    <button class="print-btn" onclick="printFromPreview()" style="margin-top:0.75rem; padding:0.6rem 1.5rem; background:var(--accent); color:white; border:none; border-radius:var(--radius-sm); font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:600; cursor:pointer; box-shadow:var(--shadow-md); transition:all 0.2s;">üñ®Ô∏è Skriv ut ukeplan</button>
    </div>`;

  // Group picker
  h += '<div class="group-picker"><div class="gp-wrap" id="gp-wrap">';
  allGroups.forEach(gn => {
    h += `<button class="gp-btn ${gn===selGroup?'sel':''}" data-group="${esc(gn)}">${esc(gn)}</button>`;
  });
  h += '</div></div>';

  // Calendar
  const cal = [];
  for (let r=0; r<4; r++) { const row=[]; for(let c=0;c<5;c++) { const el=document.getElementById(`c${r}${c}`); row.push(el?el.value:''); } cal.push(row); }
  if (cal.some(r=>r.some(c=>c.trim()))) {
    h += '<div class="p-calendar fade-in"><table class="p-cal-table"><thead><tr><th>Uke</th>';
    DAYS.forEach(d => h += `<th>${d.substring(0,3)}</th>`);
    h += '</tr></thead><tbody>';
    const wkN = parseInt(wk);
    cal.forEach((row,ri) => {
      h += `<tr><td>${wkN+ri}</td>`;
      row.forEach(cell => { h += cell.trim() ? `<td class="has-ev">${cell}</td>` : '<td>‚Äì</td>'; });
      h += '</tr>';
    });
    h += '</tbody></table></div>';
  }

  // Collect homework for selected group
  const hwByDay = {};
  DAYS.forEach(d => hwByDay[d] = []);

  subjects.forEach(s => {
    // Collect all matching homework entries for this subject
    const entries = [];

    s.groups.forEach(g => {
      const isExactMatch = g.name === selGroup;
      const isGeneralGroup = !allGroups.includes(g.name);

      if ((isExactMatch || isGeneralGroup) && g.hw && g.hw.trim() && g.day) {
        const teacherName = isGeneralGroup ? (g.name.replace(/\s*8$/, '') || g.teachers) : '';
        entries.push({ day: g.day, text: g.hw.trim(), teacher: teacherName, isGeneral: isGeneralGroup });
      }
    });

    // Group entries by day for this subject
    const byDay = {};
    entries.forEach(e => {
      if (!byDay[e.day]) byDay[e.day] = [];
      byDay[e.day].push(e);
    });

    // For each day, decide whether to merge into one card or keep separate
    Object.keys(byDay).forEach(day => {
      const dayEntries = byDay[day];
      const hasMultipleGroups = dayEntries.length > 1 && dayEntries.some(e => e.teacher);

      if (hasMultipleGroups) {
        // Merge into one card with sub-lines per teacher group
        const subLines = dayEntries.map(e => ({
          teacher: e.teacher,
          text: e.text
        }));
        hwByDay[day].push({ subj: s.name, tag: s.tag, text: '', subLines: subLines, merged: true });
      } else {
        // Single entry ‚Äì add normally
        const e = dayEntries[0];
        const hwText = e.teacher ? `(${e.teacher}) ${e.text}` : e.text;
        hwByDay[day].push({ subj: s.name, tag: s.tag, text: hwText });
      }
    });
  });

  // Equipment
  const eqItems = [];
  subjects.forEach(s => {
    const eq = document.getElementById('eq-' + subjects.indexOf(s));
    const eqVal = eq ? eq.value : s.equip;
    if (eqVal && eqVal.trim()) eqItems.push({ name: s.name, tag: s.tag, text: eqVal });
  });
  if (eqItems.length) {
    h += '<div class="equip-strip fade-in"><h3>üéí Utstyr √• ha med</h3><div class="equip-list">';
    eqItems.forEach(e => { h += `<span class="equip-chip"><span class="hw-tag ${e.tag}" style="margin:0">${e.name}</span> ${e.text}</span>`; });
    h += '</div></div>';
  }

  // Alerts (after equipment)
  if (info.trim()) {
    h += '<div class="p-alerts fade-in">';
    info.split('\n').filter(l=>l.trim()).forEach(line => {
      // Show if line mentions selected group or is general
      const lower = line.toLowerCase();
      const mentions = allGroups.filter(g => lower.includes(g.toLowerCase() + ':') || lower.includes(g.toLowerCase() + ' :'));
      if (mentions.length > 0 && !mentions.includes(selGroup)) return;
      h += `<div class="p-alert"><span>üìå</span><span>${line}</span></div>`;
    });
    h += '</div>';
  }

  // Tema/M√•l section - NOW ON PAGE 1 (before calendar)
  const temaData = [];
  subjects.forEach(s => {
    // For each subject, check if any group matches the selected class
    const matchingGroups = s.groups.filter(g => {
      // Match exact class group name (8A, 8B) or any non-class group (math groups, Spansk, Alle, etc.)
      return g.name === selGroup || !allGroups.includes(g.name);
    });

    // If we have matching groups with tema, add them
    if (matchingGroups.length > 0) {
      if (s.id === 'matte') {
        // For math, group by identical tema
        const temaGroups = {};
        matchingGroups.forEach(g => {
          if (g.tema && g.tema.trim()) {
            const temaKey = g.tema.trim();
            if (!temaGroups[temaKey]) {
              temaGroups[temaKey] = [];
            }
            // Remove " 8" from the end of the name
            const cleanName = g.name.replace(/\s*8$/, '');
            temaGroups[temaKey].push(cleanName);
          }
        });

        // Add one entry per unique tema with all teacher names
        Object.keys(temaGroups).forEach(tema => {
          const teachers = temaGroups[tema].join(', ');
          const subjName = `${s.name} (${teachers})`;
          temaData.push({ subj: subjName, tag: s.tag, tema: tema });
        });
      } else {
        // For other subjects, add normally
        matchingGroups.forEach(g => {
          if (g.tema && g.tema.trim()) {
            temaData.push({ subj: s.name, tag: s.tag, tema: g.tema });
          }
        });
      }
    }
  });

  if (temaData.length) {
    h += '<div class="tema-section"><h3>üìö Tema og l√¶ringsm√•l denne uken</h3>';
    h += '<table class="tema-table">';
    temaData.forEach(t => {
      h += `<tr><td class="tema-subject ${t.tag}">${t.subj}</td><td class="tema-text">${t.tema}</td></tr>`;
    });
    h += '</table></div>';
  }

  // Second page header
  h += `<div class="print-header print-header-page2">Lekser uke ${wk} ‚Äì Klasse <span class="${classColor}">${selGroup}</span> ‚Äì Lunner ungdomsskole</div>`;

  // Homework per day

  DAYS.forEach((day, di) => {
    h += `<div class="day-block fade-in"><div class="day-strip">
      <span class="day-dot"></span><span class="day-lbl">${day}</span><span class="day-dt">${dates[di]}</span><div class="day-rule"></div>
    </div>`;
    const items = hwByDay[day];
    if (!items.length) {
      h += '<div class="hw-empty">Ingen lekse til denne dagen ‚ú®</div>';
    } else {
      h += '<div class="hw-cards">';
      items.forEach(it => {
        if (it.merged && it.subLines) {
          // Merged card ‚Äì one subject tag, multiple teacher lines
          h += `<div class="hw-card hw-card-merged">
            <div class="hw-checkbox"></div>
            <span class="hw-tag ${it.tag}">${it.subj}</span>
            <div class="hw-body">`;
          it.subLines.forEach(sl => {
            h += `<div class="hw-subline"><span class="hw-teacher-tag ${it.tag}-inv">${sl.teacher}</span> <span class="hw-body-text">${sl.text}</span></div>`;
          });
          h += `</div></div>`;
        } else {
          h += `<div class="hw-card">
            <div class="hw-checkbox"></div>
            <span class="hw-tag ${it.tag}">${it.subj}</span>
            <div class="hw-body"><div class="hw-body-text">${it.text}</div></div>
          </div>`;
        }
      });
      h += '</div>';
    }
    h += '</div>';
  });

  // Footer at the end
  h += '<div class="page-footer">Gaute Eltvik Dyrnes ¬∑ Lunner ungdomsskole ¬∑ <a href="mailto:gaute.dyrnes@lunnerskole.no">gaute.dyrnes@lunnerskole.no</a> ¬∑ ¬© ' + new Date().getFullYear() + '</div>';

  document.getElementById('parent-view').innerHTML = h;

  // Attach event listeners for group picker buttons
  document.querySelectorAll('#gp-wrap .gp-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selGroup = btn.dataset.group;
      renderParent();
    });
  });

  // Count total homework items and apply compact class if needed
  const totalHW = Object.values(hwByDay).reduce((sum, items) => sum + items.length, 0);
  const parentView = document.getElementById('parent-view');
  if (totalHW >= 15) {
    parentView.classList.add('hw-compact');
  } else {
    parentView.classList.remove('hw-compact');
  }
}

function fmtRange(s,e) {
  const mo = ['januar','februar','mars','april','mai','juni','juli','august','september','oktober','november','desember'];
  const sd=new Date(s), ed=new Date(e);
  return `${sd.getDate()}. ${mo[sd.getMonth()]} ‚Äì ${ed.getDate()}. ${mo[ed.getMonth()]}`;
}

// ‚ïê‚ïê‚ïê MODE SWITCH ‚ïê‚ïê‚ïê
let curMode = 'teacher';
function setMode(m) {
  curMode = m;
  document.querySelectorAll('.mode-btn').forEach((b,i) => b.classList.toggle('active', (m==='teacher'&&i===0)||(m==='parent'&&i===1)));
  if (m==='teacher') {
    document.getElementById('teacher-view').style.display='';
    document.getElementById('parent-view').style.display='none';
  } else {
    // Sync equip values from inputs
    subjects.forEach((s,si) => { const el=document.getElementById('eq-'+si); if(el) s.equip=el.value; });
    document.getElementById('teacher-view').style.display='none';
    document.getElementById('parent-view').style.display='';
    renderParent();
  }
}

let currentWeek = 7; // Track current week

function getISOWeekNumber(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  const yearStart = new Date(d.getFullYear(), 0, 1);
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return weekNo;
}

function initializeWeek() {
  const today = new Date();
  const currentISOWeek = getISOWeekNumber(today);
  const nextWeek = currentISOWeek + 1;
  
  // Set the week number field
  document.getElementById('weekNum').value = nextWeek;
  currentWeek = nextWeek;
  
  // Update everything
  document.getElementById('topbar-title').textContent = `Ukeplan ‚Äì Uke ${nextWeek}`;
  updateCalendarWeeks();
  updateWeekDates();
}

// Called when week NUMBER changes ‚Äì recalculate dates and switch doc
function updWeekNum() {
  const oldWeek = currentWeek;
  const newWeek = parseInt(document.getElementById('weekNum').value);

  // Save old week's calendar data
  for (let r = 0; r < 4; r++) {
    const week = oldWeek + r;
    const row = [];
    for (let c = 0; c < 5; c++) {
      const el = document.getElementById(`c${r}${c}`);
      row.push(el ? el.value : '');
    }
    calendarData[week] = row;
  }

  currentWeek = newWeek;
  document.getElementById('topbar-title').textContent = `Ukeplan ‚Äì Uke ${newWeek}`;
  updateCalendarWeeks();
  updateWeekDates();

  // Re-establish realtime sync for new docId
  setupRealtimeSync();
}

// Called when date fields are changed manually ‚Äì only update title, don't recalculate dates
function updDateOnly() {
  saveToFirebase();
}

function updateCalendarWeeks() {
  const baseWeek = parseInt(document.getElementById('weekNum').value);
  for (let i = 0; i < 4; i++) {
    const wkEl = document.getElementById('wk' + i);
    if (wkEl) wkEl.textContent = baseWeek + i;
  }
  loadCalendarData();
}

function saveCalendarData() {
  // Save current input values to calendarData
  const baseWeek = parseInt(document.getElementById('weekNum').value);
  for (let r = 0; r < 4; r++) {
    const week = baseWeek + r;
    const row = [];
    for (let c = 0; c < 5; c++) {
      const el = document.getElementById(`c${r}${c}`);
      row.push(el ? el.value : '');
    }
    calendarData[week] = row;
  }
}

function loadCalendarData() {
  // Load data from calendarData into input fields
  const baseWeek = parseInt(document.getElementById('weekNum').value);
  for (let r = 0; r < 4; r++) {
    const week = baseWeek + r;
    const weekData = calendarData[week] || ['', '', '', '', ''];
    for (let c = 0; c < 5; c++) {
      const el = document.getElementById(`c${r}${c}`);
      if (el) el.value = weekData[c] || '';
    }
  }
}

// Get all calendar data as an object (pure getter, no side effects)
function getCalendarData() {
  return calendarData;
}

// Set calendar data from Firebase
function setCalendarData(data) {
  // Replace calendarData with data from Firebase
  Object.keys(data).forEach(week => {
    calendarData[week] = data[week];
  });
  // Load current week's data into inputs
  loadCalendarData();
}

function updateWeekDates() {
  const weekNum = parseInt(document.getElementById('weekNum').value);
  const year = new Date().getFullYear();
  
  // Calculate Monday of the selected week
  const jan4 = new Date(year, 0, 4);
  const dayOfWeek = jan4.getDay() || 7; // Sunday = 7
  const mondayOfWeek1 = new Date(jan4);
  mondayOfWeek1.setDate(jan4.getDate() - dayOfWeek + 1);
  
  const monday = new Date(mondayOfWeek1);
  monday.setDate(mondayOfWeek1.getDate() + (weekNum - 1) * 7);
  
  const friday = new Date(monday);
  friday.setDate(monday.getDate() + 4);
  
  // Format as YYYY-MM-DD
  const formatDate = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  
  document.getElementById('weekStart').value = formatDate(monday);
  document.getElementById('weekEnd').value = formatDate(friday);
}
function printParent() {
  setMode('parent');
  setTimeout(() => {
    // Set document title for PDF filename
    const wk = document.getElementById('weekNum').value;
    const originalTitle = document.title;
    document.title = `Ukeplan ${selGroup} uke ${wk}`;

    window.print();

    // Restore original title after print dialog
    setTimeout(() => {
      document.title = originalTitle;
    }, 100);
  }, 300);
}

function printFromPreview() {
  // Set document title for PDF filename when printing from preview
  const wk = document.getElementById('weekNum').value;
  const originalTitle = document.title;
  document.title = `Ukeplan ${selGroup} uke ${wk}`;

  window.print();

  // Restore original title after print dialog
  setTimeout(() => {
    document.title = originalTitle;
  }, 100);
}

function saveData() { showToast('Utkast lagret!'); }
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE AUTH & SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentUser = null;
let unsubscribeSnapshot = null;
let isLoadingFromFirebase = false; // Flag to prevent saving while loading
let lastSaveTimestamp = null; // Track when we last saved

// Dynamic Firestore document ID based on year + week + grade
function getDocId() {
  const weekNum = document.getElementById('weekNum').value || currentWeek || '7';
  const year = new Date().getFullYear();
  return `${year}-W${weekNum}-8trinn`;
}

// Determine which week to load at startup
function getStartupWeek() {
  // Check localStorage for last used week
  const saved = localStorage.getItem('ukeplan-current-week');
  if (saved) return parseInt(saved);
  // Otherwise default to next week
  const today = new Date();
  return getISOWeekNumber(today) + 1;
}

// Save current week to localStorage
function rememberWeek(wk) {
  localStorage.setItem('ukeplan-current-week', wk);
}

function showAuthError(msg) {
  const errorDiv = document.getElementById('auth-error');
  errorDiv.textContent = msg;
  errorDiv.style.display = 'block';
  setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
}

function showLogin() {
  document.getElementById('login-form').style.display = '';
}

function handleLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  if (!email || !password) {
    showAuthError('Fyll inn e-post og passord');
    return;
  }

  window.auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      console.log('Login successful');
      // Success handled by onAuthStateChanged
    })
    .catch((error) => {
      console.error('Login error:', error);
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
        showAuthError('Feil e-post eller passord');
      } else if (error.code === 'auth/invalid-email') {
        showAuthError('Ugyldig e-postadresse');
      } else {
        showAuthError('Innlogging feilet: ' + error.message);
      }
    });
}


function handleLogout() {
  if (unsubscribeSnapshot) {
    unsubscribeSnapshot();
    unsubscribeSnapshot = null;
  }
  window.auth.signOut();
}

// Debounce timer for saving
let saveTimeout = null;

// Immediate save to Firebase (no debounce)
async function saveToFirebaseNow() {
  if (!currentUser) {
    console.warn('Cannot save: User not logged in');
    return;
  }

  // Don't save while loading from Firebase
  if (isLoadingFromFirebase) {
    console.log('‚è∏Ô∏è Skipping save: Currently loading from Firebase');
    return;
  }

  const timestamp = new Date().toISOString();
  lastSaveTimestamp = timestamp; // Track this save

  // Sync calendar inputs to calendarData before saving
  saveCalendarData();

  // Remember which week we're working on
  rememberWeek(document.getElementById('weekNum').value);

  const data = {
    subjects: subjects,
    weekNum: document.getElementById('weekNum').value,
    weekStart: document.getElementById('weekStart').value,
    weekEnd: document.getElementById('weekEnd').value,
    infoText: document.getElementById('infoText').value,
    calendar: getCalendarData(),
    lastUpdated: timestamp,
    lastUpdatedBy: currentUser.email,
    lastUpdatedByUid: currentUser.uid
  };

  const docId = getDocId();
  try {
    await window.db.collection('ukeplaner').doc(docId).set(data);
    console.log('‚úÖ Data saved to Firebase doc:', docId, 'at', new Date().toLocaleTimeString(), '- subjects:', data.subjects.map(s => s.id + ':' + s.groups.length + 'groups').join(', '));
    showToast('Lagret ‚úì');
  } catch (error) {
    console.error('‚ùå Error saving to Firebase:', error);
    showToast('‚ö†Ô∏è Lagring feilet: ' + error.message);
  }
}

// Save data to Firestore with debouncing
function saveToFirebase() {
  if (!currentUser) {
    console.warn('Cannot save: User not logged in');
    return;
  }

  // Don't save while loading from Firebase
  if (isLoadingFromFirebase) {
    console.log('‚è∏Ô∏è Skipping save: Currently loading from Firebase');
    return;
  }

  // Clear existing timeout
  if (saveTimeout) {
    clearTimeout(saveTimeout);
  }

  // Debounce: wait 800ms before saving
  saveTimeout = setTimeout(saveToFirebaseNow, 800);
}

// Load data from Firestore
async function loadFromFirebase() {
  if (!currentUser) {
    console.warn('Cannot load: User not logged in');
    return;
  }

  const loadDocId = getDocId();
  console.log('üì• Loading data from Firebase, doc:', loadDocId, 'weekNum:', document.getElementById('weekNum').value);
  isLoadingFromFirebase = true; // Set flag to prevent saving during load

  try {
    let docSnap = await window.db.collection('ukeplaner').doc(loadDocId).get();

    // Migration: if new docId doesn't exist, check the old 'current' document
    if (!docSnap.exists) {
      console.log('üì¶ Doc not found, checking legacy "current" document...');
      const legacySnap = await window.db.collection('ukeplaner').doc('current').get();
      if (legacySnap.exists) {
        console.log('üì¶ Found legacy "current" doc, migrating...');
        const legacyData = legacySnap.data();
        // Save it under the new docId
        await window.db.collection('ukeplaner').doc(loadDocId).set(legacyData);
        docSnap = await window.db.collection('ukeplaner').doc(loadDocId).get();
        console.log('‚úÖ Migration complete: current ‚Üí ' + loadDocId);
      }
    }

    if (docSnap.exists) {
      const data = docSnap.data();
      console.log('üì¶ Data received from Firebase:', {
        subjects: data.subjects ? data.subjects.length + ' subjects' : 'none',
        weekNum: data.weekNum,
        lastUpdatedBy: data.lastUpdatedBy,
        lastUpdated: data.lastUpdated
      });

      // Load data - DON'T use 'if' checks, always overwrite
      subjects.length = 0; // Clear existing subjects
      subjects.push(...data.subjects); // Add new subjects

      const loadedWeek = data.weekNum || 7;
      document.getElementById('weekNum').value = loadedWeek;
      document.getElementById('weekStart').value = data.weekStart || '';
      document.getElementById('weekEnd').value = data.weekEnd || '';
      document.getElementById('infoText').value = data.infoText || '';

      // IMPORTANT: Update currentWeek to match loaded week
      currentWeek = loadedWeek;

      if (data.calendar) setCalendarData(data.calendar);

      // Re-render (but skip updTitle since we just set the week)
      renderForms();
      document.getElementById('topbar-title').textContent = `Ukeplan ‚Äì Uke ${loadedWeek}`;
      updateCalendarWeeks();
      updateWeekDates();
      autoGrowAll();
      loadCalendarData();

      console.log('‚úÖ Data loaded successfully');
      showToast('Data lastet fra databasen');
    } else {
      console.log('‚ö†Ô∏è No data found in Firebase, using defaults and saving');
      // Initialize with defaults
      initializeWeek();
      renderForms();
      autoGrowAll();
      loadCalendarData();

      // Temporarily allow saving for initial save
      isLoadingFromFirebase = false;
      await saveToFirebaseNow();
      isLoadingFromFirebase = true; // Set back to prevent further saves
    }
  } catch (error) {
    console.error('‚ùå Error loading from Firebase:', error);
    showToast('Lasting feilet: ' + error.message);
  } finally {
    // Always clear the loading flag when done
    isLoadingFromFirebase = false;
    console.log('üîì Loading complete, saving enabled');
  }
}

// Listen for real-time updates
function setupRealtimeSync() {
  if (!currentUser) return;

  // Unsubscribe from previous listener if any
  if (unsubscribeSnapshot) {
    unsubscribeSnapshot();
    unsubscribeSnapshot = null;
  }

  const docId = getDocId();
  console.log('üîÑ Setting up real-time sync for:', docId);

  unsubscribeSnapshot = window.db.collection('ukeplaner').doc(docId).onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();

      console.log('üîÑ Snapshot received:', {
        lastUpdatedBy: data.lastUpdatedBy,
        lastUpdatedByUid: data.lastUpdatedByUid,
        lastUpdated: data.lastUpdated,
        isOwnUpdate: data.lastUpdatedByUid === currentUser.uid,
        isSameAsLastSave: data.lastUpdated === lastSaveTimestamp
      });

      // Only update if changed by another user AND not from our own save
      const isOwnUpdate = data.lastUpdatedByUid === currentUser.uid;
      const isSameAsLastSave = data.lastUpdated === lastSaveTimestamp;

      if (!isOwnUpdate || !isSameAsLastSave) {
        // This is either from another user, or an old update coming in
        if (!isOwnUpdate) {
          console.log('üîî Data updated by another user:', data.lastUpdatedBy);
        } else {
          console.log('‚ö†Ô∏è Received old snapshot, ignoring');
          return; // Ignore old snapshots from ourselves
        }

        // Set flag to prevent saving while updating from remote
        isLoadingFromFirebase = true;

        // Load the updated data - clear and replace subjects
        subjects.length = 0;
        subjects.push(...data.subjects);

        const syncedWeek = data.weekNum || 7;
        document.getElementById('weekNum').value = syncedWeek;
        document.getElementById('weekStart').value = data.weekStart || '';
        document.getElementById('weekEnd').value = data.weekEnd || '';
        document.getElementById('infoText').value = data.infoText || '';

        // IMPORTANT: Update currentWeek to match synced week
        currentWeek = syncedWeek;

        if (data.calendar) setCalendarData(data.calendar);

        // Re-render (but skip updTitle to avoid triggering save)
        renderForms();
        document.getElementById('topbar-title').textContent = `Ukeplan ‚Äì Uke ${syncedWeek}`;
        updateCalendarWeeks();
        updateWeekDates();
        autoGrowAll();
        if (curMode === 'parent') renderParent();

        // Clear flag after updating
        isLoadingFromFirebase = false;

        showToast('Data oppdatert av ' + data.lastUpdatedBy);
      } else {
        console.log('‚úì Snapshot is from our own save, ignoring');
      }
    }
  });
}

// Auth state observer
window.auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    console.log('User logged in:', user.email);

    // Hide auth screen, show app
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('user-info').style.display = '';
    document.getElementById('user-email').textContent = user.email;

    // Set correct week BEFORE loading so getDocId() points to the right document
    const startupWeek = getStartupWeek();
    document.getElementById('weekNum').value = startupWeek;
    currentWeek = startupWeek;
    document.getElementById('topbar-title').textContent = `Ukeplan ‚Äì Uke ${startupWeek}`;

    // Load data from Firebase
    await loadFromFirebase();

    // Setup real-time sync
    setupRealtimeSync();

  } else {
    currentUser = null;
    console.log('User logged out');

    // Show auth screen, hide app
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('user-info').style.display = 'none';

    // Unsubscribe from real-time updates
    if (unsubscribeSnapshot) {
      unsubscribeSnapshot();
      unsubscribeSnapshot = null;
    }
  }
});

// Override updGroup to save to Firebase
const originalUpdGroup = updGroup;
updGroup = function(si, gi, field, val) {
  originalUpdGroup(si, gi, field, val);
  saveToFirebase();
};

// Override week number change to save to Firebase
const originalUpdWeekNum = updWeekNum;
updWeekNum = function() {
  originalUpdWeekNum();
  saveToFirebase();
};

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
// NOTE: Don't initialize data here - wait for Firebase to load via onAuthStateChanged

// Add input listeners to calendar inputs (save while typing)
for (let r = 0; r < 4; r++) {
  for (let c = 0; c < 5; c++) {
    const el = document.getElementById(`c${r}${c}`);
    if (el) el.addEventListener('input', () => {
      saveCalendarData();
      saveToFirebase();
    });
  }
}

// Save info text to Firebase when changed
document.getElementById('infoText').addEventListener('input', saveToFirebase);
</script>
</body>
</html>
